<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>食光小精靈 | 個人熱量追蹤助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        /* 莫蘭迪配色定義 */
        :root {
            --m-purple: #a997ab; /* 主色：莫蘭迪紫 */
            --m-red: #c29494;    /* 強調色：乾燥玫瑰紅 */
            --m-blue: #91a8d0;   /* 輔助色：莫蘭迪藍 */
            --m-green: #b5c1a0;  /* 輔助色：莫蘭迪綠 */
            --m-bg: #f5f5f3;     /* 整體背景灰 */
        }
        
        body { 
            background-color: var(--m-bg); 
            min-height: 100vh; 
            color: #5a5a5a; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            justify-content: center;
        }

        /* 模擬手機寬度容器 */
        .app-container {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            background: var(--m-bg);
            position: relative;
        }

        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
        .ingredient-row:first-child .btn-remove { display: none; }
        
        .bg-morandi-purple { background-color: var(--m-purple); }
        .text-morandi-purple { color: var(--m-purple); }
        
        /* 移除斜體限制 */
        * { font-style: normal !important; }
        
        /* 隱藏原生日期選擇器的預設圖標，改用自定義樣式 */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        /* 平滑進度條 */
        .progress-bar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="antialiased">
    <div class="app-container p-5 md:p-6 pb-20">
        <!-- Header -->
        <header class="text-center mb-6 pt-6">
            <h1 class="text-3xl font-bold text-slate-600 mb-1 tracking-[0.15em]">食光小精靈</h1>
            <div class="flex items-center justify-center gap-2">
                <span class="h-[1px] w-4 bg-slate-300"></span>
                <p class="text-slate-400 font-medium text-[10px] tracking-[0.3em] uppercase">Daily Summary</p>
                <span class="h-[1px] w-4 bg-slate-300"></span>
            </div>
        </header>

        <!-- 日曆與進度看板 -->
        <section id="dailyStats" class="glass rounded-[2rem] shadow-sm p-6 mb-6 border border-white/50 relative">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeDate(-1)" class="text-slate-300 hover:text-morandi-purple transition p-1">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div class="text-center relative">
                    <p id="viewDateLabel" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">今日總覽</p>
                    <div class="flex items-center justify-center gap-2 text-slate-600 font-bold">
                        <span id="displayDateText">載入中...</span>
                        <div class="relative w-4 h-4">
                            <i class="fas fa-calendar-alt text-xs text-slate-300"></i>
                            <input type="date" id="datePicker" onchange="onDateChanged(this.value)" class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                    </div>
                </div>

                <button onclick="changeDate(1)" class="text-slate-300 hover:text-morandi-purple transition p-1">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="text-center mb-6">
                <h2 class="text-4xl font-bold text-slate-600 tracking-tight"><span id="totalKcal">0</span> <small class="text-xs font-normal text-slate-400">kcal</small></h2>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1.5">
                    <div class="flex justify-between items-end px-1">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">蛋白質</span>
                        <span class="text-[10px] text-slate-500 font-medium"><span id="sumProtein">0</span>g</span>
                    </div>
                    <div class="h-1.5 bg-slate-100/50 rounded-full overflow-hidden border border-white/20">
                        <div id="barProtein" class="progress-bar h-full bg-[#91a8d0]" style="width: 0%"></div>
                    </div>
                </div>
                <div class="space-y-1.5">
                    <div class="flex justify-between items-end px-1">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">油脂</span>
                        <span class="text-[10px] text-slate-500 font-medium"><span id="sumFat">0</span>g</span>
                    </div>
                    <div class="h-1.5 bg-slate-100/50 rounded-full overflow-hidden border border-white/20">
                        <div id="barFat" class="progress-bar h-full bg-[#c29494]" style="width: 0%"></div>
                    </div>
                </div>
                <div class="space-y-1.5">
                    <div class="flex justify-between items-end px-1">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">碳水</span>
                        <span class="text-[10px] text-slate-500 font-medium"><span id="sumCarb">0</span>g</span>
                    </div>
                    <div class="h-1.5 bg-slate-100/50 rounded-full overflow-hidden border border-white/20">
                        <div id="barCarb" class="progress-bar h-full bg-[#b5c1a0]" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings -->
        <details class="mb-6 bg-white/60 rounded-2xl shadow-sm overflow-hidden border border-white/80">
            <summary class="cursor-pointer text-[10px] text-slate-400 p-4 hover:bg-white/80 transition uppercase tracking-widest list-none flex justify-between items-center">
                <span><i class="fas fa-magic mr-1"></i> 魔法設定中心</span>
                <i class="fas fa-chevron-down text-[8px]"></i>
            </summary>
            <div class="p-4 pt-0 space-y-3">
                <input type="password" id="geminiKey" placeholder="Gemini API Key" class="w-full p-3 bg-white/80 border border-slate-100 rounded-xl text-xs outline-none focus:ring-1 focus:ring-purple-200">
                <input type="text" id="gasUrl" placeholder="Google Script URL (小郵差網址)" class="w-full p-3 bg-white/80 border border-slate-100 rounded-xl text-xs outline-none focus:ring-1 focus:ring-purple-200">
            </div>
        </details>

        <!-- Main Interface -->
        <div class="glass rounded-[2.5rem] shadow-lg overflow-hidden mb-6 border border-white/50">
            <!-- Tabs -->
            <div class="flex bg-slate-100/40 p-1.5 gap-1.5 m-2 rounded-2xl">
                <button onclick="switchTab('cook')" id="tabCook" class="flex-1 py-2.5 text-sm font-bold rounded-xl transition-all duration-300 bg-white shadow-sm text-slate-600">
                    <i class="fas fa-hat-chef mr-1.5 text-xs"></i>自己煮
                </button>
                <button onclick="switchTab('eatout')" id="tabEatout" class="flex-1 py-2.5 text-sm font-bold rounded-xl transition-all duration-300 text-slate-400 hover:bg-white/50">
                    <i class="fas fa-shop mr-1.5 text-xs"></i>去外食
                </button>
            </div>

            <!-- Content Area -->
            <div class="p-5 pt-2">
                <!-- Cook Form -->
                <div id="formCook" class="space-y-4">
                    <div id="ingredientList" class="space-y-3">
                        <div class="ingredient-row flex flex-col gap-2 bg-white/50 p-4 rounded-2xl border border-white/50 shadow-sm">
                            <input type="text" placeholder="食材與份量 (如: 糙米飯 1碗)" class="ing-input w-full p-2.5 bg-white/80 border border-slate-50 rounded-xl text-sm outline-none focus:border-purple-200 transition">
                            <div class="flex gap-2">
                                <select class="ing-method flex-1 p-2.5 bg-white/80 border border-slate-50 rounded-xl text-xs text-slate-500 outline-none">
                                    <option value="水煮/清蒸">水煮/清蒸</option>
                                    <option value="快炒 (少量油)">快炒 (少量油)</option>
                                    <option value="油炸/煎">油炸/煎</option>
                                    <option value="烘烤">烘烤</option>
                                    <option value="水果/生食">水果/生食</option>
                                </select>
                                <button onclick="removeRow(this)" class="btn-remove px-3 text-slate-300 hover:text-rose-300 transition">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="addRow()" class="w-full py-3 border border-dashed border-slate-300 rounded-2xl text-slate-400 hover:text-purple-400 transition text-xs font-bold bg-white/10">
                        <i class="fas fa-plus-circle mr-1"></i> 新增食材項
                    </button>
                </div>

                <!-- Eatout Form -->
                <div id="formEatout" class="hidden space-y-4">
                    <input type="text" id="eatInput" placeholder="例如：巷口乾麵 或 7-11 涼麵" class="w-full p-4 bg-white/80 border border-slate-50 rounded-2xl text-sm focus:outline-none focus:border-purple-200 transition shadow-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/40 p-3 rounded-2xl border border-white">
                            <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-tighter">總熱量</label>
                            <input type="number" id="eatKcal" placeholder="AI 估算" class="w-full bg-transparent text-sm outline-none">
                        </div>
                        <div class="bg-white/40 p-3 rounded-2xl border border-white">
                            <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-tighter">蛋白質</label>
                            <input type="number" id="eatProtein" placeholder="AI 估算" class="w-full bg-transparent text-sm outline-none">
                        </div>
                        <div class="bg-white/40 p-3 rounded-2xl border border-white">
                            <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-tighter">脂肪</label>
                            <input type="number" id="eatFat" placeholder="AI 估算" class="w-full bg-transparent text-sm outline-none">
                        </div>
                        <div class="bg-white/40 p-3 rounded-2xl border border-white">
                            <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-tighter">碳水</label>
                            <input type="number" id="eatCarb" placeholder="AI 估算" class="w-full bg-transparent text-sm outline-none">
                        </div>
                    </div>
                </div>

                <button onclick="analyzeFood()" id="btnAnalyze" class="w-full mt-8 bg-morandi-purple hover:brightness-105 text-white font-bold py-4 rounded-2xl shadow-md transition-all duration-300 flex justify-center items-center tracking-[0.4em] text-sm">
                    <span id="btnText">交給小精靈吧</span>
                    <i id="loadingIcon" class="fas fa-wand-sparkles fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </div>

        <!-- Result Preview -->
        <div id="resultArea" class="hidden glass rounded-[2.5rem] shadow-xl p-6 border border-white/50 mb-10">
            <h3 class="text-sm font-bold text-slate-500 mb-6 text-center tracking-[0.2em]">✨ 小精靈的分析筆記</h3>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-white/60 p-4 rounded-3xl border border-white flex flex-col items-center">
                    <span class="text-[9px] text-slate-400 font-bold uppercase mb-1">蛋白質</span>
                    <span class="text-xl font-bold text-slate-600"><span id="resProtein">0</span><small class="text-[10px] ml-0.5 text-slate-400">g</small></span>
                </div>
                <div class="bg-white/60 p-4 rounded-3xl border border-white flex flex-col items-center">
                    <span class="text-[9px] text-slate-400 font-bold uppercase mb-1">油脂</span>
                    <span class="text-xl font-bold text-slate-600"><span id="resFat">0</span><small class="text-[10px] ml-0.5 text-slate-400">g</small></span>
                </div>
                <div class="bg-white/60 p-4 rounded-3xl border border-white flex flex-col items-center">
                    <span class="text-[9px] text-slate-400 font-bold uppercase mb-1">碳水</span>
                    <span class="text-xl font-bold text-slate-600"><span id="resCarb">0</span><small class="text-[10px] ml-0.5 text-slate-400">g</small></span>
                </div>
                <div class="bg-white/60 p-4 rounded-3xl border border-white flex flex-col items-center">
                    <span class="text-[9px] text-slate-400 font-bold uppercase mb-1">總熱量</span>
                    <span class="text-xl font-bold text-slate-600"><span id="resKcal">0</span><small class="text-[10px] ml-0.5 text-slate-400">kc</small></span>
                </div>
            </div>
            
            <div class="text-xs leading-relaxed text-slate-500 mb-6 bg-white/40 p-4 rounded-2xl border border-white" id="resSummary"></div>
            
            <button onclick="saveData()" id="btnSave" class="w-full bg-slate-400 hover:bg-slate-500 text-white font-bold py-4 rounded-2xl transition duration-300 shadow-sm text-xs flex justify-center items-center">
                <span id="saveBtnText"><i class="fas fa-cloud-upload-alt mr-2"></i>記錄數據</span>
                <i id="saveLoadingIcon" class="fas fa-circle-notch fa-spin ml-2 hidden"></i>
            </button>
            <p id="saveMsg" class="text-center text-[9px] mt-4 text-slate-400 font-medium tracking-wider uppercase"></p>
        </div>
    </div>

    <script>
        let currentMode = 'cook';
        let currentAnalysis = null;
        let selectedDate = new Date();

        window.onload = () => {
            document.getElementById('geminiKey').value = localStorage.getItem('gemini_api_key') || '';
            document.getElementById('gasUrl').value = localStorage.getItem('gas_url') || '';
            updateDateDisplay();
        };

        // UI 行列操作
        function addRow() {
            const list = document.getElementById('ingredientList');
            const newRow = document.querySelector('.ingredient-row').cloneNode(true);
            newRow.querySelector('input').value = '';
            list.appendChild(newRow);
        }

        function removeRow(btn) {
            const row = btn.closest('.ingredient-row');
            if (document.querySelectorAll('.ingredient-row').length > 1) row.remove();
        }

        function switchTab(mode) {
            currentMode = mode;
            const isCook = mode === 'cook';
            document.getElementById('tabCook').className = `flex-1 py-2.5 text-sm font-bold rounded-xl transition-all duration-300 ${isCook ? 'bg-white shadow-sm text-slate-600' : 'text-slate-400 hover:bg-white/50'}`;
            document.getElementById('tabEatout').className = `flex-1 py-2.5 text-sm font-bold rounded-xl transition-all duration-300 ${!isCook ? 'bg-white shadow-sm text-slate-600' : 'text-slate-400 hover:bg-white/50'}`;
            document.getElementById('formCook').classList.toggle('hidden', !isCook);
            document.getElementById('formEatout').classList.toggle('hidden', isCook);
        }

        // 日期切換邏輯
        function changeDate(days) {
            selectedDate.setDate(selectedDate.getDate() + days);
            updateDateDisplay();
        }

        function onDateChanged(val) {
            if (!val) return;
            selectedDate = new Date(val);
            updateDateDisplay();
        }

        function updateDateDisplay() {
            const today = new Date();
            const dateStr = selectedDate.toLocaleDateString('zh-TW');
            const isToday = dateStr === today.toLocaleDateString('zh-TW');
            
            document.getElementById('displayDateText').innerText = dateStr;
            document.getElementById('viewDateLabel').innerText = isToday ? "今日總覽" : "歷史紀錄";
            document.getElementById('datePicker').value = selectedDate.toISOString().split('T')[0];
            
            fetchDailySummary();
        }

        // 從 GAS 獲取當日加總
        async function fetchDailySummary() {
            const gasUrl = document.getElementById('gasUrl').value;
            if (!gasUrl) return;
            
            const kcalEl = document.getElementById('totalKcal');
            kcalEl.classList.add('opacity-40');
            
            try {
                // 將日期格式化為 yyyy/M/d 以匹配 backend.gs 的邏輯
                const dateStr = selectedDate.getFullYear() + "/" + (selectedDate.getMonth() + 1) + "/" + selectedDate.getDate();
                const response = await fetch(`${gasUrl}?action=getSummary&date=${encodeURIComponent(dateStr)}`);
                const result = await response.json();
                
                document.getElementById('totalKcal').innerText = result.kcal;
                document.getElementById('sumProtein').innerText = result.protein;
                document.getElementById('sumFat').innerText = result.fat;
                document.getElementById('sumCarb').innerText = result.carb;
                
                // 更新進度條 (預設基準：蛋白 60g, 油脂 50g, 碳水 250g)
                document.getElementById('barProtein').style.width = Math.min((result.protein / 60) * 100, 100) + '%';
                document.getElementById('barFat').style.width = Math.min((result.fat / 50) * 100, 100) + '%';
                document.getElementById('barCarb').style.width = Math.min((result.carb / 250) * 100, 100) + '%';
                
            } catch (error) {
                console.error("無法同步數據", error);
            } finally {
                kcalEl.classList.remove('opacity-40');
            }
        }

        // AI 分析功能
        async function analyzeFood() {
            const apiKey = document.getElementById('geminiKey').value;
            if (!apiKey) { alert("請先輸入魔法金鑰 (Gemini API Key)"); return; }
            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.setItem('gas_url', document.getElementById('gasUrl').value);

            const btnText = document.getElementById('btnText');
            const loadingIcon = document.getElementById('loadingIcon');
            const btnAnalyze = document.getElementById('btnAnalyze');

            let userInput = "";
            if (currentMode === 'cook') {
                const rows = Array.from(document.querySelectorAll('.ingredient-row')).map(row => {
                    const input = row.querySelector('.ing-input').value;
                    const method = row.querySelector('.ing-method').value;
                    return input ? `- 食材與份量: ${input} (烹調法: ${method})` : '';
                }).filter(t => t).join('\n');
                userInput = `【自己煮模式】\n${rows}`;
            } else {
                userInput = `【外食模式】\n品項: ${document.getElementById('eatInput').value}\n數值參考: 熱量 ${document.getElementById('eatKcal').value}, 蛋白 ${document.getElementById('eatProtein').value}, 脂肪 ${document.getElementById('eatFat').value}, 碳水 ${document.getElementById('eatCarb').value}`;
            }

            if (!userInput.trim() || (currentMode === 'cook' && userInput.length < 20)) { alert("請告訴小精靈你吃了什麼喔！"); return; }

            btnText.innerText = "小精靈搬運數據中...";
            loadingIcon.classList.remove('hidden');
            btnAnalyze.disabled = true;

            const systemPrompt = `你是一位精確的營養分析師，請將內容轉換為 JSON 格式。
            規則：
            1. 自己煮模式下，根據食材體積（如拳頭、碗、根）估算重量與營養。
            2. 外食模式下，優先採用使用者數值；若為空，則按大眾餐飲平均標準估算。
            3. 回傳純 JSON，不得包含 Markdown 標籤：{"item": "品項名稱", "protein": 數字, "fat": 數字, "carb": 數字, "kcal": 數字, "summary": "簡短溫柔的分析語句"}。`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `系統指令: ${systemPrompt}\n內容:\n${userInput}` }] }]
                    })
                });

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                currentAnalysis = JSON.parse(jsonStr);

                document.getElementById('resProtein').innerText = currentAnalysis.protein;
                document.getElementById('resFat').innerText = currentAnalysis.fat;
                document.getElementById('resCarb').innerText = currentAnalysis.carb;
                document.getElementById('resKcal').innerText = currentAnalysis.kcal;
                document.getElementById('resSummary').innerText = currentAnalysis.summary;
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error(error);
                alert("魔法失效了，請檢查 API Key 或連線。");
            } finally {
                btnText.innerText = "交給小精靈吧";
                loadingIcon.classList.add('hidden');
                btnAnalyze.disabled = false;
            }
        }

        // 存檔至 Google Sheets
        async function saveData() {
            const gasUrl = document.getElementById('gasUrl').value;
            if (!currentAnalysis || !gasUrl) { alert("請先完成分析並設定小郵差網址 (GAS URL)"); return; }
            
            const btnSave = document.getElementById('btnSave');
            const saveLoadingIcon = document.getElementById('saveLoadingIcon');
            const saveMsg = document.getElementById('saveMsg');
            
            btnSave.disabled = true;
            saveLoadingIcon.classList.remove('hidden');

            const now = new Date();
            // 日期格式固定為 yyyy/M/d 與 GAS 匹配
            const dateStr = now.getFullYear() + "/" + (now.getMonth() + 1) + "/" + now.getDate();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            
            const payload = {
                date: dateStr,
                time: timeStr,
                item: currentAnalysis.item,
                protein: currentAnalysis.protein,
                fat: currentAnalysis.fat,
                carb: currentAnalysis.carb,
                kcal: currentAnalysis.kcal
            };

            try {
                await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'no-cors', // GAS POST 必須使用 no-cors
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                saveMsg.innerText = "✨ 紀錄成功！小精靈已經寫好筆記了。";
                // 存檔後切換回今天並重新抓取加總
                selectedDate = new Date();
                updateDateDisplay();
                // 隱藏結果區塊
                setTimeout(() => { document.getElementById('resultArea').classList.add('hidden'); }, 2000);
            } catch (error) {
                console.error(error);
                saveMsg.innerText = "❌ 紀錄失敗，請檢查 URL 配置。";
            } finally {
                btnSave.disabled = false;
                saveLoadingIcon.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
