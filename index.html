<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>食光小精靈 | 個人熱量追蹤助手</title>
    <!-- 載入基礎庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --m-purple: #a997ab;
            --m-red: #c29494;
            --m-blue: #91a8d0;
            --m-green: #b5c1a0;
            --m-bg: #f5f5f3;
        }
        body { 
            background-color: var(--m-bg); 
            min-height: 100vh; 
            color: #5a5a5a; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
        }
        .app-container {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            background: var(--m-bg);
            position: relative;
        }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
        * { font-style: normal !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .progress-bar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }
        .btn-active { background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #475569; }
        .stats-loading { opacity: 0.5; filter: blur(1px); }
        .animate-pulse-subtle { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // 自定義 SVG 圖標，解決語法與相容性問題
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                ChefHat: <path d="M6 13.812l-2.82 2.821a2 2 0 0 1-2.82-2.82l3.06-3.06a4.46 4.46 0 1 1 5.39 5.39l-3.06 3.06a2 2 0 0 1-2.82-2.82L6 13.812zm0 0l4-4a2 2 0 1 1 2.82 2.82l-4 4M6 13.812v6M10 9.812v6" />,
                Store: <path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4M2 7h20M10 7V2M14 7V2" />,
                PlusCircle: <g><circle cx="12" cy="12" r="10" /><path d="M12 8v8M8 12h8" /></g>,
                MinusCircle: <g><circle cx="12" cy="12" r="10" /><path d="M8 12h8" /></g>,
                Calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><path d="M16 2v4M8 2v4M3 10h18" /></g>,
                ChevronLeft: <path d="m15 18-6-6 6-6" />,
                ChevronRight: <path d="m9 18 6-6-6-6" />,
                Settings2: <g><path d="M20 7h-9M14 17H5M17 12H7M7 2v10M12 7v10M17 12v10" /></g>,
                CloudUpload: <g><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9M16 16l-4-4-4 4" /></g>,
                RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16M3 21v-5h5" /></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10" /><path d="M12 8v4M12 16h.01" /></g>,
                Search: <g><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('cook');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [loading, setLoading] = useState(false);
            const [isFetchingStats, setIsFetchingStats] = useState(false);
            const [saveLoading, setSaveLoading] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [dailyStats, setDailyStats] = useState({ kcal: 0, protein: 0, fat: 0, carb: 0 });
            const [saveMsg, setSaveMsg] = useState('');
            
            // 本地設定
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [gasUrl, setGasUrl] = useState(localStorage.getItem('gas_url') || '');
            const [modelName, setModelName] = useState(localStorage.getItem('gemini_model') || 'gemini-2.5-flash');
            const [apiVersion, setApiVersion] = useState(localStorage.getItem('gemini_api_version') || 'v1beta');

            // 狀態定義
            const [ingredients, setIngredients] = useState([{ id: Date.now(), text: '', method: '水煮/清蒸' }]);
            const [eatData, setEatData] = useState({ name: '', kcal: '', protein: '', fat: '', carb: '' });

            // 核心功能：從 Google 試算表抓取當日加總
            useEffect(() => {
                fetchSummary();
            }, [selectedDate, gasUrl]);

            const fetchSummary = async () => {
                // 安全檢查：確保網址有效
                if (!gasUrl || !gasUrl.startsWith('https://script.google.com')) {
                    console.log("尚未設定正確的 GAS URL");
                    return;
                }
                
                setIsFetchingStats(true);
                try {
                    // 格式化日期與 GAS 匹配 (yyyy/M/d)
                    const dateStr = `${selectedDate.getFullYear()}/${selectedDate.getMonth() + 1}/${selectedDate.getDate()}`;
                    const url = `${gasUrl}?action=getSummary&date=${encodeURIComponent(dateStr)}`;
                    
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        setDailyStats({
                            kcal: Number(data.kcal) || 0,
                            protein: Number(data.protein) || 0,
                            fat: Number(data.fat) || 0,
                            carb: Number(data.carb) || 0
                        });
                    } else {
                        throw new Error("無法連通 Google Script");
                    }
                } catch (e) { 
                    console.error("同步失敗", e); 
                } finally {
                    setIsFetchingStats(false);
                }
            };

            const checkAvailableModels = async () => {
                if (!apiKey) { setSaveMsg("⚠️ 請先在設定中填入 API Key"); return; }
                setLoading(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/${apiVersion}/models?key=${apiKey}`);
                    const data = await response.json();
                    if (data.models) {
                        const names = data.models
                            .filter(m => m.supportedGenerationMethods.includes('generateContent'))
                            .map(m => m.name.replace('models/', ''));
                        setSaveMsg(`✅ 金鑰支援：${names.slice(0, 3).join(', ')}。請於下方選取。`);
                    }
                } catch (e) {
                    setSaveMsg(`❌ 查詢失敗：${e.message}`);
                } finally { setLoading(false); }
            };

            const handleAddIngredient = () => {
                setIngredients([...ingredients, { id: Date.now(), text: '', method: '水煮/清蒸' }]);
            };

            const handleRemoveIngredient = (id) => {
                if (ingredients.length > 1) {
                    setIngredients(ingredients.filter(ing => ing.id !== id));
                }
            };

            const analyzeFood = async () => {
                if (!apiKey) { setSaveMsg("⚠️ 請先設定 API Key"); return; }
                setLoading(true);
                setSaveMsg('');
                setAnalysisResult(null);

                let userInput = activeTab === 'cook' 
                    ? ingredients.map(ing => `- ${ing.text} (${ing.method})`).join('\n')
                    : `外食品項: ${eatData.name}, 數值: ${eatData.kcal}kcal, P:${eatData.protein}, F:${eatData.fat}, C:${eatData.carb}`;

                const promptPayload = `你是一位專業營養師。請分析以下飲食並僅回傳 JSON。格式範例：{"item": "品項名稱", "protein": 數字, "fat": 數字, "carb": 數字, "kcal": 數字, "summary": "分析結論"}。
                
                內容：
                ${userInput}`;

                try {
                    const endpoint = `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${apiKey}`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptPayload }] }],
                            generationConfig: { temperature: 0.1 }
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || "分析失敗");

                    let textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (textResult) {
                        textResult = textResult.replace(/```json/g, "").replace(/```/g, "").trim();
                        setAnalysisResult(JSON.parse(textResult));
                    }
                } catch (e) {
                    setSaveMsg(`❌ 分析失敗: ${e.message}`);
                } finally { setLoading(false); }
            };

            const saveData = async () => {
                if (!analysisResult || !gasUrl || !gasUrl.startsWith('https://')) {
                    setSaveMsg("⚠️ 請確認小郵差網址設定正確");
                    return;
                }
                setSaveLoading(true);
                const now = new Date();
                const dateStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
                const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                const payload = {
                    date: dateStr, time: timeStr, item: analysisResult.item,
                    protein: analysisResult.protein, fat: analysisResult.fat,
                    carb: analysisResult.carb, kcal: analysisResult.kcal
                };
                try {
                    // 使用 no-cors 是 GAS 的通訊協定規範
                    await fetch(gasUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    setSaveMsg("✨ 紀錄成功！正在同步雲端數據...");
                    setAnalysisResult(null);
                    // 給後端一點時間處理後再抓取摘要
                    setTimeout(fetchSummary, 1500);
                } catch (e) { 
                    setSaveMsg("❌ 儲存失敗"); 
                } finally { 
                    setSaveLoading(false); 
                }
            };

            const isToday = selectedDate.toLocaleDateString() === new Date().toLocaleDateString();

            return (
                <div className="app-container p-5 md:p-6 pb-20">
                    <header className="text-center mb-6 pt-6">
                        <h1 className="text-3xl font-bold text-slate-600 mb-1 tracking-widest uppercase">食光小精靈</h1>
                        <p className="text-slate-400 font-medium text-[10px] tracking-widest uppercase font-sans">Pocket Nutritionist</p>
                    </header>

                    {/* 數據看板 */}
                    <section className={`glass rounded-[2.5rem] shadow-sm p-6 mb-6 border border-white relative overflow-hidden transition-all duration-300 ${isFetchingStats ? 'stats-loading' : ''}`}>
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={() => { let d = new Date(selectedDate); d.setDate(d.getDate()-1); setSelectedDate(d); }} className="text-slate-300 transition hover:text-purple-400 p-2"><Icon name="ChevronLeft" size={20}/></button>
                            <div className="text-center">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">{isToday ? "今日總覽" : "歷史紀錄"}</p>
                                <div className="flex items-center gap-2 text-slate-600 font-bold">
                                    <span>{selectedDate.toLocaleDateString('zh-TW')}</span>
                                    <div className="relative w-4 h-4">
                                        <Icon name="Calendar" size={12} className="text-slate-300" />
                                        <input type="date" onChange={(e) => { if(e.target.value) setSelectedDate(new Date(e.target.value)); }} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => { let d = new Date(selectedDate); d.setDate(d.getDate()+1); setSelectedDate(d); }} className="text-slate-300 transition hover:text-purple-400 p-2"><Icon name="ChevronRight" size={20}/></button>
                        </div>
                        
                        <div className={`text-center mb-6 ${isFetchingStats ? 'animate-pulse-subtle' : ''}`}>
                            <h2 className="text-4xl font-bold text-slate-600 tracking-tight">
                                {dailyStats.kcal} <small className="text-xs font-normal text-slate-400">kcal</small>
                            </h2>
                        </div>

                        <div className="space-y-4">
                            {[
                                { l: '蛋白質', v: dailyStats.protein, c: 'bg-[#91a8d0]', t: 60 }, 
                                { l: '脂肪', v: dailyStats.fat, c: 'bg-[#c29494]', t: 50 }, 
                                { l: '碳水', v: dailyStats.carb, c: 'bg-[#b5c1a0]', t: 250 }
                            ].map(i => (
                                <div key={i.l} className="space-y-1">
                                    <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-tight">
                                        <span>{i.l}</span>
                                        <span className="text-slate-500">{i.v}g</span>
                                    </div>
                                    <div className="h-1.5 bg-slate-100/50 rounded-full overflow-hidden border border-white/10">
                                        <div className={`${i.c} h-full progress-bar`} style={{ width: `${Math.min((i.v/i.t)*100, 100)}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {isFetchingStats && <div className="absolute top-2 right-6"><Icon name="RefreshCw" className="animate-spin text-purple-300" size={12} /></div>}
                    </section>

                    {/* 魔法設定中心 */}
                    <details className="mb-6 bg-white/40 rounded-2xl overflow-hidden border border-white/60">
                        <summary className="p-4 text-[10px] text-slate-400 cursor-pointer flex justify-between items-center list-none font-bold uppercase tracking-widest">
                            <span className="flex items-center gap-1.5"><Icon name="Settings2" size={12}/> 魔法設定中心</span>
                        </summary>
                        <div className="px-4 pb-4 space-y-3">
                            <div>
                                <label className="block text-[9px] text-slate-400 mb-1 uppercase tracking-tighter">Gemini API Key</label>
                                <div className="flex gap-2">
                                    <input type="password" value={apiKey} onChange={(e) => { setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value); }} className="flex-1 p-2.5 bg-white/80 border border-slate-100 rounded-xl text-xs outline-none focus:ring-1 focus:ring-purple-200 transition-all" />
                                    <button onClick={checkAvailableModels} title="查詢可用模型" className="p-2.5 bg-slate-200 rounded-xl hover:bg-slate-300 transition-all"><Icon name="Search" size={14} /></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="block text-[9px] text-slate-400 mb-1 uppercase tracking-tighter">版本</label>
                                    <select value={apiVersion} onChange={(e) => { setApiVersion(e.target.value); localStorage.setItem('gemini_api_version', e.target.value); }} className="w-full p-2.5 bg-white/80 border border-slate-100 rounded-xl text-[10px] outline-none">
                                        <option value="v1beta">v1beta (推薦)</option>
                                        <option value="v1">v1 (穩定版)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-[9px] text-slate-400 mb-1 uppercase tracking-tighter">模型名稱</label>
                                    <select value={modelName} onChange={(e) => { setModelName(e.target.value); localStorage.setItem('gemini_model', e.target.value); }} className="w-full p-2.5 bg-white/80 border border-slate-100 rounded-xl text-[10px] outline-none">
                                        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                                        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                                        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                                        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-[9px] text-slate-400 mb-1 uppercase tracking-tighter">Google Script URL (小郵差網址)</label>
                                <input type="text" value={gasUrl} placeholder="https://script.google.com/macros/s/..." onChange={(e) => { setGasUrl(e.target.value); localStorage.setItem('gas_url', e.target.value); }} className="w-full p-2.5 bg-white/80 border border-slate-100 rounded-xl text-xs outline-none" />
                            </div>
                        </div>
                    </details>

                    {/* 輸入區塊 */}
                    <div className="glass rounded-[2.5rem] shadow-lg overflow-hidden mb-6 border border-white">
                        <div className="flex bg-slate-100/40 p-1.5 gap-1.5 m-2 rounded-2xl">
                            <button onClick={() => setActiveTab('cook')} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${activeTab === 'cook' ? 'btn-active' : 'text-slate-400'}`}>自己煮</button>
                            <button onClick={() => setActiveTab('eatout')} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${activeTab === 'eatout' ? 'btn-active' : 'text-slate-400'}`}>去外食</button>
                        </div>
                        <div className="p-5 pt-2">
                            {activeTab === 'cook' ? (
                                <div className="space-y-4">
                                    {ingredients.map(ing => (
                                        <div key={ing.id} className="bg-white/50 p-4 rounded-2xl border border-white/50 space-y-2">
                                            <input type="text" placeholder="食材份量 (如: 鯖魚 1條)" value={ing.text} onChange={(e) => setIngredients(ingredients.map(i => i.id === ing.id ? {...i, text: e.target.value} : i))} className="w-full p-2 bg-white/80 border border-slate-50 rounded-xl text-sm outline-none focus:border-purple-200 transition-all" />
                                            <div className="flex gap-2">
                                                <select value={ing.method} onChange={(e) => setIngredients(ingredients.map(i => i.id === ing.id ? {...i, method: e.target.value} : i))} className="flex-1 p-2 bg-white/80 border border-slate-50 rounded-xl text-xs text-slate-500 outline-none">
                                                    <option>水煮/清蒸</option><option>快炒 (少量油)</option><option>油炸/煎</option><option>烘烤</option><option>水果/生食</option>
                                                </select>
                                                <button onClick={() => handleRemoveIngredient(ing.id)} className="text-slate-300 hover:text-red-400 p-1 transition-colors"><Icon name="MinusCircle" size={20}/></button>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={handleAddIngredient} className="w-full py-3 border border-dashed border-slate-300 rounded-2xl text-slate-400 text-xs font-bold bg-white/10 hover:border-[#a997ab] transition-all">新增食材</button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <input type="text" placeholder="品項名稱 (如: 牛肉麵)" value={eatData.name} onChange={(e) => setEatData({...eatData, name: e.target.value})} className="w-full p-4 bg-white/80 border border-slate-50 rounded-2xl text-sm outline-none focus:border-purple-200 transition-all" />
                                    <div className="grid grid-cols-2 gap-3">
                                        {[{ l: '總熱量', k: 'kcal' }, { l: '蛋白質', k: 'protein' }, { l: '脂肪', k: 'fat' }, { l: '碳水', k: 'carb' }].map(f => (
                                            <div key={f.k} className="bg-white/40 p-3 rounded-2xl border border-white">
                                                <label className="block text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-tight">{f.l}</label>
                                                <input type="number" placeholder="自動" value={eatData[f.k]} onChange={(e) => setEatData({...eatData, [f.k]: e.target.value})} className="w-full bg-transparent text-sm outline-none" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <button onClick={analyzeFood} disabled={loading} className="w-full mt-8 bg-[#a997ab] text-white font-bold py-4 rounded-2xl shadow-md transition-all flex justify-center items-center tracking-widest text-sm hover:brightness-105 active:scale-95">
                                {loading ? <Icon name="RefreshCw" size={18} className="animate-spin" /> : "交給小精靈吧"}
                            </button>
                        </div>
                    </div>

                    {/* 分析結果 */}
                    {analysisResult && (
                        <div className="glass rounded-[2.5rem] shadow-xl p-6 mt-6 border border-white animate-in slide-in-from-bottom-4 duration-500">
                            <h3 className="text-sm font-bold text-slate-500 mb-6 text-center tracking-widest uppercase">✨ 小精靈筆記</h3>
                            <div className="grid grid-cols-2 gap-3 mb-6">
                                {[{ l: '蛋白質', v: analysisResult.protein, u: 'g' }, { l: '脂肪', v: analysisResult.fat, u: 'g' }, { l: '碳水', v: analysisResult.carb, u: 'g' }, { l: '總熱量', v: analysisResult.kcal, u: 'kc' }].map(r => (
                                    <div key={r.l} className="bg-white/60 p-4 rounded-3xl border border-white flex flex-col items-center">
                                        <span className="text-[9px] text-slate-400 font-bold uppercase mb-1">{r.l}</span>
                                        <span className="text-xl font-bold text-slate-600">{r.v}<small className="text-[10px] ml-0.5 text-slate-400">{r.u}</small></span>
                                    </div>
                                ))}
                            </div>
                            <div className="text-xs leading-relaxed text-slate-500 mb-6 bg-white/40 p-4 rounded-2xl border border-white leading-relaxed">{analysisResult.summary}</div>
                            <button onClick={saveData} disabled={saveLoading} className="w-full bg-[#8fa0a8] text-white font-bold py-4 rounded-2xl transition shadow-sm text-xs flex justify-center items-center hover:brightness-105">
                                {saveLoading ? <Icon name="RefreshCw" size={14} className="animate-spin mr-2" /> : <Icon name="CloudUpload" size={14} className="mr-2"/>} 記錄數據
                            </button>
                        </div>
                    )}
                    
                    {saveMsg && (
                        <div className={`p-4 mt-4 rounded-2xl text-[11px] font-medium text-center flex items-center justify-center gap-2 ${saveMsg.includes('❌') || saveMsg.includes('⚠️') ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>
                            {(saveMsg.includes('❌') || saveMsg.includes('⚠️')) && <Icon name="AlertCircle" size={14} />}
                            {saveMsg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
