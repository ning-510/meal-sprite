<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>食光小精靈 | 個人熱量追蹤助手</title>
    <!-- 載入 React 與 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --m-purple: #a997ab;
            --m-red: #c29494;
            --m-blue: #91a8d0;
            --m-green: #b5c1a0;
            --m-bg: #f5f5f3;
        }
        body { 
            background-color: var(--m-bg); 
            min-height: 100vh; 
            color: #5a5a5a; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
        }
        .app-container {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            background: var(--m-bg);
            position: relative;
        }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
        * { font-style: normal !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .progress-bar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 內建圖標組件，解決外部庫載入失敗與語法錯誤問題
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                ChefHat: <path d="M6 13.812l-2.82 2.821a2 2 0 0 1-2.82-2.82l3.06-3.06a4.46 4.46 0 1 1 5.39 5.39l-3.06 3.06a2 2 0 0 1-2.82-2.82L6 13.812zm0 0l4-4a2 2 0 1 1 2.82 2.82l-4 4M6 13.812v6M10 9.812v6" />,
                Store: <path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4M2 7h20M10 7V2M14 7V2" />,
                PlusCircle: <g><circle cx="12" cy="12" r="10" /><path d="M12 8v8M8 12h8" /></g>,
                MinusCircle: <g><circle cx="12" cy="12" r="10" /><path d="M8 12h8" /></g>,
                Calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><path d="M16 2v4M8 2v4M3 10h18" /></g>,
                ChevronLeft: <path d="m15 18-6-6 6-6" />,
                ChevronRight: <path d="m9 18 6-6-6-6" />,
                Settings2: <g><path d="M20 7h-9M14 17H5M17 12H7M7 2v10M12 7v10M17 12v10" /></g>,
                CloudUpload: <g><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9M16 16l-4-4-4 4" /></g>,
                RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16M3 21v-5h5" /></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10" /><path d="M12 8v4M12 16h.01" /></g>,
                Wand2: <g><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.21 1.21 0 0 0 1.72 0L21.64 5.36a1.21 1.21 0 0 0 0-1.72M14 7l3 3M5 6v1M19 17v1M6 19h1M17 5h1M11 1l1 1M1 11l1 1M22 11l1 1M11 22l1 1" /></g>
            };

            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {icons[name] || null}
                </svg>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('cook');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [loading, setLoading] = useState(false);
            const [saveLoading, setSaveLoading] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [dailyStats, setDailyStats] = useState({ kcal: 0, protein: 0, fat: 0, carb: 0 });
            const [saveMsg, setSaveMsg] = useState('');
            
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [gasUrl, setGasUrl] = useState(localStorage.getItem('gas_url') || '');

            const [ingredients, setIngredients] = useState([{ id: Date.now(), text: '', method: '水煮/清蒸' }]);
            const [eatData, setEatData] = useState({ name: '', kcal: '', protein: '', fat: '', carb: '' });

            useEffect(() => {
                fetchSummary();
            }, [selectedDate, gasUrl]);

            const fetchWithRetry = async (url, options, maxRetries = 5) => {
                let delay = 1000;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) return await response.json();
                        if (response.status === 429 || response.status >= 500) {
                            if (i === maxRetries - 1) throw new Error(`API 請求頻繁，小精靈稍後重試 (${response.status})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    } catch (err) {
                        if (i === maxRetries - 1) throw err;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            };

            const fetchSummary = async () => {
                if (!gasUrl) return;
                try {
                    const dateStr = `${selectedDate.getFullYear()}/${selectedDate.getMonth() + 1}/${selectedDate.getDate()}`;
                    const response = await fetch(`${gasUrl}?action=getSummary&date=${encodeURIComponent(dateStr)}`);
                    if (response.ok) {
                        const data = await response.json();
                        setDailyStats(data);
                    }
                } catch (e) {
                    console.error("無法同步數據", e);
                }
            };

            const handleAddIngredient = () => {
                setIngredients([...ingredients, { id: Date.now(), text: '', method: '水煮/清蒸' }]);
            };

            const handleRemoveIngredient = (id) => {
                if (ingredients.length > 1) {
                    setIngredients(ingredients.filter(ing => ing.id !== id));
                }
            };

            const analyzeFood = async () => {
                if (!apiKey) { 
                    setSaveMsg("⚠️ 請先在魔法設定中心輸入 API Key");
                    return; 
                }
                setLoading(true);
                setSaveMsg('');
                setAnalysisResult(null);

                let prompt = "";
                if (activeTab === 'cook') {
                    const items = ingredients.map(ing => `- ${ing.text} (烹調方式: ${ing.method})`).join('\n');
                    prompt = `【自己煮】內容如下，請分析各食材重量並計算營養組成：\n${items}`;
                } else {
                    prompt = `【外食】內容如下，優先參考已知數值，不足處請補齊：\n品項: ${eatData.name}\n熱量 ${eatData.kcal}, 蛋白 ${eatData.protein}, 脂肪 ${eatData.fat}, 碳水 ${eatData.carb}`;
                }

                const systemPrompt = `你是一位專業的營養師。請將飲食解析為 JSON。
                規則：
                1. 必須回傳純 JSON 格式：{"item": "品項名稱", "protein": 數字, "fat": 數字, "carb": 數字, "kcal": 數字, "summary": "溫柔的分析語句"}
                2. 如果有提到「個」、「碗」、「份」等模糊單位，請按常理換算成公克。
                3. 嚴禁在回傳中包含 Markdown 代碼塊標籤 (\`\`\`json)。`;

                try {
                    // 更換為廣泛支援的穩定模型名稱 gemini-1.5-flash
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { 
                          responseMimeType: "application/json",
                          temperature: 0.2
                        }
                    };

                    const result = await fetchWithRetry(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const textResult = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (textResult) {
                        setAnalysisResult(JSON.parse(textResult));
                    } else {
                        throw new Error("API 未回傳分析數據");
                    }
                } catch (e) {
                    setSaveMsg(`❌ 分析失敗: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const saveData = async () => {
                if (!analysisResult || !gasUrl) return;
                setSaveLoading(true);
                
                const now = new Date();
                const dateStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
                const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

                const payload = {
                    date: dateStr,
                    time: timeStr,
                    item: analysisResult.item,
                    protein: analysisResult.protein,
                    fat: analysisResult.fat,
                    carb: analysisResult.carb,
                    kcal: analysisResult.kcal
                };

                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(payload)
                    });
                    setSaveMsg("✨ 紀錄成功！小精靈已經寫好筆記了。");
                    setSelectedDate(new Date());
                    setAnalysisResult(null);
                    setTimeout(fetchSummary, 1000);
                } catch (e) {
                    setSaveMsg("❌ 紀錄失敗，請檢查表格連線。");
                } finally {
                    setSaveLoading(false);
                }
            };

            const dateStr = selectedDate.toLocaleDateString('zh-TW');
            const isToday = dateStr === new Date().toLocaleDateString('zh-TW');

            return (
                <div className="app-container p-5 md:p-6 pb-20">
                    <header className="text-center mb-6 pt-6">
                        <h1 className="text-3xl font-bold text-slate-600 mb-1 tracking-[0.15em]">食光小精靈</h1>
                        <div className="flex items-center justify-center gap-2">
                            <span className="h-[1px] w-4 bg-slate-300"></span>
                            <p className="text-slate-400 font-medium text-[10px] tracking-widest uppercase">Dietary Elf</p>
                            <span className="h-[1px] w-4 bg-slate-300"></span>
                        </div>
                    </header>

                    <section className="glass rounded-[2rem] shadow-sm p-6 mb-6 border border-white relative overflow-hidden">
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={() => {
                                const d = new Date(selectedDate);
                                d.setDate(d.getDate() - 1);
                                setSelectedDate(d);
                            }} className="text-slate-300 hover:text-[#a997ab] transition">
                                <Icon name="ChevronLeft" size={20} />
                            </button>
                            
                            <div className="text-center relative">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">{isToday ? "今日總覽" : "歷史紀錄"}</p>
                                <div className="flex items-center justify-center gap-2 text-slate-600 font-bold">
                                    <span>{dateStr}</span>
                                    <div className="relative w-4 h-4">
                                        <Icon name="Calendar" size={12} className="text-slate-300" />
                                        <input type="date" onChange={(e) => setSelectedDate(new Date(e.target.value))} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                            </div>

                            <button onClick={() => {
                                const d = new Date(selectedDate);
                                d.setDate(d.getDate() + 1);
                                setSelectedDate(d);
                            }} className="text-slate-300 hover:text-[#a997ab] transition">
                                <Icon name="ChevronRight" size={20} />
                            </button>
                        </div>

                        <div className="text-center mb-6">
                            <h2 className="text-4xl font-bold text-slate-600 tracking-tight">{dailyStats.kcal} <small className="text-xs font-normal text-slate-400">kcal</small></h2>
                        </div>
                        
                        <div className="space-y-4">
                            {[
                                { label: '蛋白質', val: dailyStats.protein, color: 'bg-[#91a8d0]', target: 60 },
                                { label: '脂肪', val: dailyStats.fat, color: 'bg-[#c29494]', target: 50 },
                                { label: '碳水', val: dailyStats.carb, color: 'bg-[#b5c1a0]', target: 250 }
                            ].map(item => (
                                <div key={item.label} className="space-y-1.5">
                                    <div className="flex justify-between text-[10px] font-bold px-1 text-slate-400 uppercase">
                                        <span>{item.label}</span>
                                        <span className="text-slate-500">{item.val}g</span>
                                    </div>
                                    <div className="h-1.5 bg-slate-100/50 rounded-full overflow-hidden border border-white/20">
                                        <div className={`${item.color} h-full progress-bar`} style={{ width: `${Math.min((item.val / item.target) * 100, 100)}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>

                    <details className="mb-6 bg-white/40 rounded-2xl overflow-hidden border border-white/60">
                        <summary className="p-4 text-[10px] text-slate-400 cursor-pointer flex justify-between items-center uppercase tracking-widest list-none">
                            <span className="flex items-center gap-1.5"><Icon name="Settings2" size={12}/> 魔法設定中心</span>
                        </summary>
                        <div className="px-4 pb-4 space-y-3">
                            <input type="password" placeholder="Gemini API Key" value={apiKey} onChange={(e) => { setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value); }} className="w-full p-3 bg-white/80 border border-slate-100 rounded-xl text-xs outline-none focus:ring-1 focus:ring-purple-200 transition" />
                            <input type="text" placeholder="https://script.google.com/macros/s/AKfycbzKPedXIVq-5TzCTwME065uCzZUQnxVOROP1wwYObil65GfxUXPoc-s_1U7LTLp242kdw/exec" value={gasUrl} onChange={(e) => { setGasUrl(e.target.value); localStorage.setItem('gas_url', e.target.value); }} className="w-full p-3 bg-white/80 border border-slate-100 rounded-xl text-xs outline-none focus:ring-1 focus:ring-purple-200 transition" />
                        </div>
                    </details>

                    <div className="glass rounded-[2.5rem] shadow-lg overflow-hidden mb-6 border border-white">
                        <div className="flex bg-slate-100/40 p-1.5 gap-1.5 m-2 rounded-2xl">
                            <button onClick={() => setActiveTab('cook')} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${activeTab === 'cook' ? 'bg-white shadow-sm text-slate-600' : 'text-slate-400'}`}>
                                <Icon name="ChefHat" size={14} className="inline mr-1.5 mb-0.5" />自己煮
                            </button>
                            <button onClick={() => setActiveTab('eatout')} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${activeTab === 'eatout' ? 'bg-white shadow-sm text-slate-600' : 'text-slate-400'}`}>
                                <Icon name="Store" size={14} className="inline mr-1.5 mb-0.5" />去外食
                            </button>
                        </div>

                        <div className="p-5 pt-2">
                            {activeTab === 'cook' ? (
                                <div className="space-y-4">
                                    <div className="space-y-3">
                                        {ingredients.map((ing) => (
                                            <div key={ing.id} className="bg-white/50 p-4 rounded-2xl border border-white/50 space-y-2">
                                                <input type="text" placeholder="食材份量 (如: 雞肉 200g)" value={ing.text} onChange={(e) => {
                                                    const newIngs = ingredients.map(i => i.id === ing.id ? {...i, text: e.target.value} : i);
                                                    setIngredients(newIngs);
                                                }} className="w-full p-2.5 bg-white/80 border border-slate-50 rounded-xl text-sm outline-none focus:border-purple-200" />
                                                <div className="flex gap-2">
                                                    <select value={ing.method} onChange={(e) => {
                                                        const newIngs = ingredients.map(i => i.id === ing.id ? {...i, method: e.target.value} : i);
                                                        setIngredients(newIngs);
                                                    }} className="flex-1 p-2.5 bg-white/80 border border-slate-50 rounded-xl text-xs text-slate-500 outline-none">
                                                        <option>水煮/清蒸</option>
                                                        <option>快炒 (少量油)</option>
                                                        <option>油炸/煎</option>
                                                        <option>烘烤</option>
                                                        <option>水果/生食</option>
                                                    </select>
                                                    <button onClick={() => handleRemoveIngredient(ing.id)} className="text-slate-300 hover:text-rose-300">
                                                        <Icon name="MinusCircle" size={20} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={handleAddIngredient} className="w-full py-3 border border-dashed border-slate-300 rounded-2xl text-slate-400 text-xs font-bold bg-white/10 hover:border-[#a997ab]">
                                        <Icon name="PlusCircle" size={14} className="inline mr-1 mb-0.5" /> 新增食材項
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <input type="text" id="eatInput" placeholder="例如：巷口乾麵 或 7-11 涼麵" value={eatData.name} onChange={(e) => setEatData({...eatData, name: e.target.value})} className="w-full p-4 bg-white/80 border border-slate-50 rounded-2xl text-sm outline-none focus:border-purple-200" />
                                    <div className="grid grid-cols-2 gap-3">
                                        {[
                                            { label: '總熱量', key: 'kcal' }, { label: '蛋白質', key: 'protein' },
                                            { label: '脂肪', key: 'fat' }, { label: '碳水', key: 'carb' }
                                        ].map(field => (
                                            <div key={field.key} className="bg-white/40 p-3 rounded-2xl border border-white">
                                                <label className="block text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-tighter">{field.label}</label>
                                                <input type="number" placeholder="自動" value={eatData[field.key]} onChange={(e) => setEatData({...eatData, [field.key]: e.target.value})} className="w-full bg-transparent text-sm outline-none" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <button onClick={analyzeFood} disabled={loading} className="w-full mt-8 bg-[#a997ab] hover:brightness-105 text-white font-bold py-4 rounded-2xl shadow-md transition-all flex justify-center items-center tracking-[0.4em] text-sm">
                                {loading ? <Icon name="RefreshCw" size={18} className="animate-spin" /> : "交給小精靈吧"}
                            </button>
                        </div>
                    </div>

                    {analysisResult && (
                        <div className="glass rounded-[2.5rem] shadow-xl p-6 border border-white animate-in slide-in-from-bottom-4 duration-500">
                            <h3 className="text-sm font-bold text-slate-500 mb-6 text-center tracking-[0.2em]">✨ 小精靈的分析筆記</h3>
                            <div className="grid grid-cols-2 gap-3 mb-6">
                                {[
                                    { label: '蛋白質', val: analysisResult.protein, unit: 'g' },
                                    { label: '脂肪', val: analysisResult.fat, unit: 'g' },
                                    { label: '碳水', val: analysisResult.carb, unit: 'g' },
                                    { label: '總熱量', val: analysisResult.kcal, unit: 'kc' }
                                ].map(res => (
                                    <div key={res.label} className="bg-white/60 p-4 rounded-3xl border border-white flex flex-col items-center">
                                        <span className="text-[9px] text-slate-400 font-bold uppercase mb-1">{res.label}</span>
                                        <span className="text-xl font-bold text-slate-600">{res.val}<small className="text-[10px] ml-0.5 text-slate-400">{res.unit}</small></span>
                                    </div>
                                ))}
                            </div>
                            <div className="text-xs leading-relaxed text-slate-500 mb-6 bg-white/40 p-4 rounded-2xl border border-white">
                                {analysisResult.summary}
                            </div>
                            <button onClick={saveData} disabled={saveLoading} className="w-full bg-[#8fa0a8] hover:bg-slate-500 text-white font-bold py-4 rounded-2xl transition duration-300 shadow-sm text-xs flex justify-center items-center">
                                {saveLoading ? <Icon name="RefreshCw" size={14} className="animate-spin mr-2" /> : <Icon name="CloudUpload" size={14} className="mr-2"/>} 記錄數據
                            </button>
                        </div>
                    )}
                    
                    {saveMsg && (
                        <div className={`p-4 mt-4 rounded-2xl text-[11px] font-medium text-center flex items-center justify-center gap-2 ${saveMsg.includes('❌') || saveMsg.includes('⚠️') ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>
                            {(saveMsg.includes('❌') || saveMsg.includes('⚠️')) && <Icon name="AlertCircle" size={14} />}
                            {saveMsg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
